{% extends "base.html" %}

{% block title %}Dashboard - Granada OS Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent animate-fade-in">
            Granada OS Admin Dashboard
        </h2>
        <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
            Refresh
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <p class="mt-2 text-gray-400">Loading dashboard data...</p>
    </div>

    <!-- Stats Grid -->
    <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 hidden" data-aos="fade-up" data-aos-delay="200">
        <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Total Users</p>
                    <p class="text-3xl font-bold" id="total-users">0</p>
                </div>
                <i data-lucide="users" class="w-8 h-8 text-blue-500"></i>
            </div>
            <div class="mt-4 flex space-x-4 text-sm">
                <span class="text-gray-400">Active: <span id="active-users">0</span></span>
                <span class="text-gray-400">Admins: <span id="admin-users">0</span></span>
            </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Opportunities</p>
                    <p class="text-3xl font-bold" id="total-opportunities">0</p>
                </div>
                <i data-lucide="globe" class="w-8 h-8 text-green-500"></i>
            </div>
            <div class="mt-4 flex space-x-4 text-sm">
                <span class="text-gray-400">Verified: <span id="verified-opportunities">0</span></span>
                <span class="text-gray-400">Countries: <span id="countries-count">0</span></span>
            </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Active Bots</p>
                    <p class="text-3xl font-bold" id="active-bots">0</p>
                </div>
                <i data-lucide="bot" class="w-8 h-8 text-purple-500"></i>
            </div>
            <div class="mt-4 text-sm text-gray-400">
                Found: <span id="total-found">0</span> opportunities
            </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">System Status</p>
                    <p class="text-2xl font-bold" id="system-status">Healthy</p>
                </div>
                <i data-lucide="check-circle" class="w-8 h-8 text-green-500" id="status-icon"></i>
            </div>
            <div class="mt-4 text-sm text-gray-400">
                Last updated: <span id="last-updated">-</span>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div id="activity-section" class="bg-gray-900 rounded-lg p-6 border border-gray-800 hidden">
        <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
        <div id="activity-list" class="space-y-3">
            <!-- Activity items will be populated here -->
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/admin/users" class="p-4 border border-gray-700 rounded-lg hover:bg-gray-800 transition-colors">
                <i data-lucide="user-plus" class="w-6 h-6 text-blue-500 mb-2"></i>
                <h4 class="font-medium">Manage Users</h4>
                <p class="text-sm text-gray-400">View and manage user accounts</p>
            </a>
            
            <a href="/admin/opportunities" class="p-4 border border-gray-700 rounded-lg hover:bg-gray-800 transition-colors">
                <i data-lucide="plus-circle" class="w-6 h-6 text-green-500 mb-2"></i>
                <h4 class="font-medium">Add Opportunity</h4>
                <p class="text-sm text-gray-400">Create new funding opportunities</p>
            </a>
            
            <a href="/admin/bots" class="p-4 border border-gray-700 rounded-lg hover:bg-gray-800 transition-colors">
                <i data-lucide="play" class="w-6 h-6 text-purple-500 mb-2"></i>
                <h4 class="font-medium">Run Bots</h4>
                <p class="text-sm text-gray-400">Execute scraping automation</p>
            </a>
            
            <a href="/admin/system" class="p-4 border border-gray-700 rounded-lg hover:bg-gray-800 transition-colors">
                <i data-lucide="monitor" class="w-6 h-6 text-orange-500 mb-2"></i>
                <h4 class="font-medium">System Monitor</h4>
                <p class="text-sm text-gray-400">View system logs and status</p>
            </a>
        </div>
    </div>
</div>

<script>
    async function loadDashboardData() {
        try {
            document.getElementById('loading').classList.remove('hidden');
            
            const data = await AdminAPI.get('/api/admin/dashboard');
            
            // Update stats
            document.getElementById('total-users').textContent = data.users.total;
            document.getElementById('active-users').textContent = data.users.active;
            document.getElementById('admin-users').textContent = data.users.admins;
            
            document.getElementById('total-opportunities').textContent = data.opportunities.total;
            document.getElementById('verified-opportunities').textContent = data.opportunities.verified;
            document.getElementById('countries-count').textContent = data.opportunities.countries;
            
            document.getElementById('active-bots').textContent = data.bots.active;
            document.getElementById('total-found').textContent = data.bots.total_found;
            
            document.getElementById('system-status').textContent = data.system.status === 'healthy' ? 'Healthy' : 'Error';
            document.getElementById('last-updated').textContent = new Date(data.system.last_updated).toLocaleTimeString();
            
            // Update status icon
            const statusIcon = document.getElementById('status-icon');
            if (data.system.status === 'healthy') {
                statusIcon.setAttribute('data-lucide', 'check-circle');
                statusIcon.className = 'w-8 h-8 text-green-500';
            } else {
                statusIcon.setAttribute('data-lucide', 'alert-circle');
                statusIcon.className = 'w-8 h-8 text-red-500';
            }
            
            // Show activity if available
            if (data.activity && data.activity.length > 0) {
                const activityList = document.getElementById('activity-list');
                activityList.innerHTML = data.activity.slice(0, 10).map(activity => `
                    <div class="flex items-center justify-between py-2 border-b border-gray-800">
                        <div>
                            <span class="font-medium">${activity.date}</span>
                            <span class="text-gray-400 ml-2">${activity.activity_count} new opportunities</span>
                        </div>
                        <span class="text-gray-400 text-sm">${activity.date}</span>
                    </div>
                `).join('');
                
                document.getElementById('activity-section').classList.remove('hidden');
            }
            
            // Show content and hide loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('stats-grid').classList.remove('hidden');
            
            // Reinitialize icons
            lucide.createIcons();
            
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            document.getElementById('loading').innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                    <p class="text-red-400">Failed to load dashboard data</p>
                    <button onclick="loadDashboardData()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Retry
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
    }
    
    function refreshData() {
        loadDashboardData();
    }
    
    // Load data on page load
    loadDashboardData();
</script>
{% endblock %}