{% extends "base.html" %}

{% block title %}Submissions - Granada OS Wabden{% endblock %}
{% block page_title %}User Submissions & Requests{% endblock %}
{% block page_subtitle %}Proposal management, research submissions, and workflow automation{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Submission Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="card-gradient rounded-xl p-6 hover-scale" data-aos="fade-up" data-aos-delay="100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm uppercase tracking-wide">Total Submissions</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ submissions|length }}</p>
                    <p class="text-blue-400 text-sm mt-1">All time</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-alt text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="card-gradient rounded-xl p-6 hover-scale" data-aos="fade-up" data-aos-delay="200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm uppercase tracking-wide">Pending Review</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ status_stats.get('pending', 0) }}</p>
                    <p class="text-orange-400 text-sm mt-1">Awaiting action</p>
                </div>
                <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-orange-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="card-gradient rounded-xl p-6 hover-scale" data-aos="fade-up" data-aos-delay="300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm uppercase tracking-wide">Approved</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ status_stats.get('approved', 0) }}</p>
                    <p class="text-green-400 text-sm mt-1">Successfully processed</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="card-gradient rounded-xl p-6 hover-scale" data-aos="fade-up" data-aos-delay="400">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm uppercase tracking-wide">In Progress</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ status_stats.get('in_progress', 0) }}</p>
                    <p class="text-purple-400 text-sm mt-1">Being worked on</p>
                </div>
                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-spinner text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions Management -->
    <div class="card-gradient rounded-xl p-6" data-aos="fade-up" data-aos-delay="500">
        <div class="flex space-x-1 mb-6">
            <button onclick="showSubmissionTab('all')" class="submission-tab-btn px-4 py-2 rounded-lg transition-all duration-300 bg-blue-600 text-white">
                <i class="fas fa-list mr-2"></i> All Submissions
            </button>
            <button onclick="showSubmissionTab('proposals')" class="submission-tab-btn px-4 py-2 rounded-lg transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                <i class="fas fa-file-contract mr-2"></i> Proposals
            </button>
            <button onclick="showSubmissionTab('research')" class="submission-tab-btn px-4 py-2 rounded-lg transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                <i class="fas fa-search mr-2"></i> Research Requests
            </button>
            <button onclick="showSubmissionTab('workflow')" class="submission-tab-btn px-4 py-2 rounded-lg transition-all duration-300 bg-gray-700 text-gray-300 hover:bg-gray-600">
                <i class="fas fa-cogs mr-2"></i> Workflow Automation
            </button>
        </div>

        <!-- All Submissions Tab -->
        <div id="all-tab" class="submission-tab-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">All User Submissions</h3>
                <div class="flex items-center space-x-4">
                    <input type="text" id="submissionSearch" placeholder="Search submissions..." 
                           class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="statusFilter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i> Export
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Title</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">User</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Type</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Status</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Date</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Priority</th>
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission in submissions %}
                        <tr class="border-b border-gray-800 hover:bg-gray-800/30 transition-colors submission-row">
                            <td class="py-4 px-4">
                                <div>
                                    <p class="text-white font-medium">{{ submission[1][:50] }}...</p>
                                    <p class="text-gray-400 text-sm">{{ submission[2][:80] }}...</p>
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <span class="text-white text-xs font-bold">{{ (submission[6] or submission[5][0]).upper() }}</span>
                                    </div>
                                    <div>
                                        <p class="text-white text-sm">{{ submission[6] or 'N/A' }} {{ submission[7] or '' }}</p>
                                        <p class="text-gray-400 text-xs">{{ submission[5] }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-full text-xs">
                                    Proposal
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                {% set status_color = 'orange' if submission[3] == 'pending' else 'green' if submission[3] == 'approved' else 'blue' if submission[3] == 'in_progress' else 'gray' %}
                                <span class="px-2 py-1 bg-{{ status_color }}-500/20 text-{{ status_color }}-400 rounded-full text-xs">
                                    {{ submission[3].replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <span class="text-gray-300 text-sm">{{ submission[4].strftime('%Y-%m-%d') }}</span>
                                <p class="text-gray-500 text-xs">{{ submission[4].strftime('%H:%M') }}</p>
                            </td>
                            <td class="py-4 px-4">
                                <span class="px-2 py-1 bg-red-500/20 text-red-400 rounded-full text-xs">
                                    High
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewSubmission('{{ submission[0] }}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">
                                        <i class="fas fa-eye mr-1"></i> View
                                    </button>
                                    {% if submission[3] == 'pending' %}
                                    <button onclick="approveSubmission('{{ submission[0] }}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">
                                        <i class="fas fa-check mr-1"></i> Approve
                                    </button>
                                    {% endif %}
                                    <button onclick="editSubmission('{{ submission[0] }}')" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded text-xs transition-colors">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Proposals Tab -->
        <div id="proposals-tab" class="submission-tab-content hidden">
            <h3 class="text-xl font-bold text-white mb-6">Proposal Management</h3>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="space-y-4">
                    <h4 class="text-lg font-medium text-white border-b border-gray-700 pb-2">Draft Proposals</h4>
                    <div class="space-y-3">
                        {% for i in range(3) %}
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <h5 class="text-white font-medium">Education Initiative {{ i + 1 }}</h5>
                            <p class="text-gray-400 text-sm">Draft • Last edited 2 hours ago</p>
                            <div class="flex space-x-2 mt-3">
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">
                                    <i class="fas fa-edit mr-1"></i> Continue
                                </button>
                                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">
                                    <i class="fas fa-paper-plane mr-1"></i> Submit
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-lg font-medium text-white border-b border-gray-700 pb-2">Under Review</h4>
                    <div class="space-y-3">
                        {% for i in range(2) %}
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <h5 class="text-white font-medium">Healthcare Project {{ i + 1 }}</h5>
                            <p class="text-gray-400 text-sm">Submitted • Under expert review</p>
                            <p class="text-orange-400 text-sm mt-2">
                                <i class="fas fa-clock mr-1"></i> 3 days remaining
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-lg font-medium text-white border-b border-gray-700 pb-2">Approved</h4>
                    <div class="space-y-3">
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <h5 class="text-white font-medium">Community Development</h5>
                            <p class="text-gray-400 text-sm">Approved • Ready for submission</p>
                            <p class="text-green-400 text-sm mt-2">
                                <i class="fas fa-check-circle mr-1"></i> Quality assured
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Requests Tab -->
        <div id="research-tab" class="submission-tab-content hidden">
            <h3 class="text-xl font-bold text-white mb-6">Research Requests</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-medium text-white mb-4">Active Research</h4>
                    <div class="space-y-4">
                        {% for i in range(4) %}
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium">Research Topic {{ i + 1 }}</h5>
                                <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs">In Progress</span>
                            </div>
                            <p class="text-gray-400 text-sm">Requested by: user{{ i + 1 }}@example.com</p>
                            <p class="text-gray-400 text-sm">Deadline: {{ (now() + timedelta(days=7+i)).strftime('%Y-%m-%d') }}</p>
                            <div class="mt-3">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Progress</span>
                                    <span class="text-blue-400">{{ 25 + (i * 20) }}%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ 25 + (i * 20) }}%"></div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <h4 class="text-lg font-medium text-white mb-4">Research Queue</h4>
                    <div class="space-y-4">
                        {% for i in range(3) %}
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium">Pending Research {{ i + 1 }}</h5>
                                <span class="px-2 py-1 bg-orange-500/20 text-orange-400 rounded-full text-xs">Queued</span>
                            </div>
                            <p class="text-gray-400 text-sm">Research type: Market Analysis</p>
                            <p class="text-gray-400 text-sm">Priority: {{ 'High' if i == 0 else 'Medium' if i == 1 else 'Low' }}</p>
                            <div class="flex space-x-2 mt-3">
                                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">
                                    <i class="fas fa-play mr-1"></i> Start
                                </button>
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">
                                    <i class="fas fa-edit mr-1"></i> Details
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Automation Tab -->
        <div id="workflow-tab" class="submission-tab-content hidden">
            <h3 class="text-xl font-bold text-white mb-6">Workflow Automation</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-medium text-white mb-4">Active Workflows</h4>
                    <div class="space-y-4">
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium">Auto Proposal Review</h5>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span class="text-green-400 text-sm">Active</span>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm">Automatically reviews incoming proposals for basic requirements</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-gray-400 text-sm">Processed today: 23</span>
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">
                                    Configure
                                </button>
                            </div>
                        </div>

                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium">Email Notifications</h5>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span class="text-green-400 text-sm">Active</span>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm">Sends automated status updates to users</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-gray-400 text-sm">Sent today: 67</span>
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors">
                                    Configure
                                </button>
                            </div>
                        </div>

                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-white font-medium">Document Processing</h5>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <span class="text-yellow-400 text-sm">Paused</span>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm">Automatically processes uploaded documents</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-gray-400 text-sm">Queue: 5 pending</span>
                                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs transition-colors">
                                    Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-lg font-medium text-white mb-4">Workflow Analytics</h4>
                    <canvas id="workflowChart" height="300"></canvas>
                    
                    <div class="mt-6 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Processing Time</span>
                            <span class="text-blue-400">-34% faster</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Error Rate</span>
                            <span class="text-green-400">0.2%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400">Automation Rate</span>
                            <span class="text-purple-400">87%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Submission Modal -->
<div id="viewSubmissionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Submission Details</h3>
            <button onclick="closeViewSubmissionModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="submissionDetails" class="space-y-6">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<script>
// Submission tab functionality
function showSubmissionTab(tabName) {
    document.querySelectorAll('.submission-tab-content').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.submission-tab-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-300');
    });
    
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    event.target.classList.remove('bg-gray-700', 'text-gray-300');
    event.target.classList.add('bg-blue-600', 'text-white');
}

// Search and filter functionality
document.getElementById('submissionSearch').addEventListener('input', filterSubmissions);
document.getElementById('statusFilter').addEventListener('change', filterSubmissions);

function filterSubmissions() {
    const searchTerm = document.getElementById('submissionSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('.submission-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = !statusFilter || text.includes(statusFilter.toLowerCase());
        
        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    });
}

// Submission management functions
function viewSubmission(submissionId) {
    document.getElementById('viewSubmissionModal').classList.remove('hidden');
    document.getElementById('viewSubmissionModal').classList.add('flex');
    
    // Load submission details (mock implementation)
    document.getElementById('submissionDetails').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg font-medium text-white mb-4">Submission Information</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Title</label>
                        <p class="text-white">Education Initiative for Rural Communities</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">User</label>
                        <p class="text-white">john.doe@example.com</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Status</label>
                        <span class="px-2 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm">Pending</span>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Submitted</label>
                        <p class="text-white">2024-12-20 14:30</p>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="text-lg font-medium text-white mb-4">Content Preview</h4>
                <div class="bg-gray-900 rounded-lg p-4 max-h-60 overflow-y-auto">
                    <p class="text-gray-300 text-sm">
                        This proposal outlines a comprehensive education initiative designed to improve 
                        literacy rates in rural communities. The project aims to establish mobile 
                        learning centers that can reach underserved areas...
                    </p>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i> Approve
                    </button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                        <i class="fas fa-edit mr-2"></i> Request Changes
                    </button>
                    <button class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                        <i class="fas fa-times mr-2"></i> Reject
                    </button>
                </div>
            </div>
        </div>
    `;
}

function closeViewSubmissionModal() {
    document.getElementById('viewSubmissionModal').classList.add('hidden');
    document.getElementById('viewSubmissionModal').classList.remove('flex');
}

function approveSubmission(submissionId) {
    if (confirm('Are you sure you want to approve this submission?')) {
        // Implementation would go here
        alert('Submission approved successfully!');
        location.reload();
    }
}

function editSubmission(submissionId) {
    alert('Edit submission functionality would be implemented here');
}

// Workflow chart
const workflowCtx = document.getElementById('workflowChart').getContext('2d');
const workflowChart = new Chart(workflowCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Processed',
            data: [12, 19, 15, 25, 22, 18, 20],
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }, {
            label: 'Automated',
            data: [10, 16, 13, 22, 19, 15, 17],
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#9CA3AF'
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: '#9CA3AF'
                }
            },
            x: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: '#9CA3AF'
                }
            }
        }
    }
});

// Close modal on outside click
document.getElementById('viewSubmissionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeViewSubmissionModal();
    }
});
</script>
{% endblock %}